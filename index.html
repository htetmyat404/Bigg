<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>BigWin Prediction</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; }
    .pill { padding: 5px 10px; border-radius: 12px; }
    .big { background: #28a745; color: #fff; }
    .small { background: #dc3545; color: #fff; }
    .card-r { border: 1px solid #444; margin: 8px; padding: 10px; border-radius: 8px; }
    .win { color: #0f0; }
    .lose { color: #f33; }
  </style>
</head>
<body>
  <h2>ðŸ”® BigWin Prediction</h2>

  <div id="nextBox" style="display:none;">
    <h3>Next Issue: <span id="nextIssue"></span></h3>
    <div>Prediction: <span id="nextPred" class="pill"></span></div>
  </div>

  <h3>History</h3>
  <div id="cards"></div>

  <h3>Stats</h3>
  Wins: <span id="winCount">0</span> |
  Loses: <span id="loseCount">0</span> |
  Win Rate: <span id="winRate">0%</span>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <script>
    // Prediction Firebase
    const predConfig = {
      apiKey: "AIzaSyArgde3-Xn0boi6FO-ZfN6vPPMRdULPN24",
      authDomain: "bigwin30-3d1e2.firebaseapp.com",
      databaseURL: "https://bigwin30-3d1e2-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "bigwin30-3d1e2",
      storageBucket: "bigwin30-3d1e2.appspot.com",
      messagingSenderId: "214823361254",
      appId: "1:214823361254:web:9b9f101f2134e2bc48f927",
      measurementId: "G-E4YSHMD6X4"
    };
    const predApp = firebase.initializeApp(predConfig, 'pred');
    const predDb  = predApp.database();
    const ref = predDb.ref("bigwin/default");

    // --- Prediction Logic ---
    const patternStr = `SMALL BIG SMALL SMALL BIG SMALL SMALL BIG BIG SMALL SMALL SMALL SMALL BIG BIG SMALL
    BIG BIG BIG SMALL SMALL BIG SMALL SMALL BIG SMALL SMALL BIG SMALL SMALL BIG SMALL
    SMALL BIG SMALL SMALL SMALL SMALL SMALL BIG SMALL BIG BIG BIG SMALL SMALL BIG BIG
    BIG BIG BIG SMALL SMALL BIG SMALL BIG BIG SMALL BIG SMALL SMALL`;

    const PATTERN = patternStr.trim().split(/\s+/).map(s => s.toUpperCase());
    const PLEN = PATTERN.length;
    const toBigIntSafe = (x) => { const s = String(x).replace(/\D/g,'') || "0"; try { return BigInt(s); } catch { return 0n; } };
    const lastDigit = (n) => { const s = String(n).trim(); const d = parseInt(s[s.length-1], 10); return Number.isNaN(d) ? 0 : d; };
    const classify  = (num) => (lastDigit(num) >= 5 ? "BIG" : "SMALL");
    const modBI = (a, m) => { const mm = BigInt(m); let r = a % mm; if (r < 0) r += mm; return r; };

    let anchorIssueStr = null, LOCKS = {};
    const ANCHOR_KEY = "bw_pattern_anchor_issue_v3";

    function renderWinrate(rows){
      const w = rows.filter(r=>r.result==="Win").length;
      const l = rows.filter(r=>r.result==="Lose").length;
      const tot = w + l;
      const rate = tot ? Math.round((w/tot)*1000)/10 : 0;
      document.getElementById("winCount").textContent = w;
      document.getElementById("loseCount").textContent = l;
      document.getElementById("winRate").textContent = rate + "%";
    }

    function cardHTML(item){
      return `
        <div class="card-r ${item.result}">
          <div>Issue: ${item.issue}</div>
          <div>Number: ${item.number}</div>
          <div>Actual: <span class="pill ${item.actual.toLowerCase()}">${item.actual}</span></div>
          <div>Predicted: <span class="pill ${item.predicted.toLowerCase()}">${item.predicted}</span></div>
          <div>Result: ${item.result}</div>
        </div>`;
    }

    const nextBox = document.getElementById("nextBox");
    const nextIssueEl = document.getElementById("nextIssue");
    const nextPredEl  = document.getElementById("nextPred");
    const cardsEl     = document.getElementById("cards");

    ref.on("value", (snap) => {
      const v = snap.val(); if (!v) return;
      const raw = Array.isArray(v.list) ? v.list.filter(Boolean)
                 : (v.list && typeof v.list === 'object') ? Object.values(v.list)
                 : [];
      const list = raw.map(it => {
        const issueStr = String(it.issue ?? "").trim();
        return { issueStr, issueBI: toBigIntSafe(issueStr), number: it.number ?? "" };
      }).filter(it => it.issueStr.length > 0);

      if (!list.length) return;
      const maxIssueBI = list.reduce((mx, it) => it.issueBI > mx ? it.issueBI : mx, -1n);
      const nextIssueBI = maxIssueBI + 1n;
      const nextIssueStr = nextIssueBI.toString();
      if (!anchorIssueStr){ anchorIssueStr = nextIssueStr; localStorage.setItem(ANCHOR_KEY, anchorIssueStr); }
      const anchorBI = toBigIntSafe(anchorIssueStr);

      const nextIdx = Number(modBI(nextIssueBI - anchorBI, PLEN));
      const shouldBe = PATTERN[nextIdx];
      if (!LOCKS[nextIssueStr]){ LOCKS[nextIssueStr] = shouldBe; }

      nextBox.style.display = "block";
      nextIssueEl.textContent = nextIssueStr;
      nextPredEl.textContent = LOCKS[nextIssueStr];
      nextPredEl.className = "pill " + (LOCKS[nextIssueStr]==="BIG"?"big":"small");

      const rowsForRate = [];
      const cards = [];
      list.forEach(item => {
        const actual = (String(item.number).trim().length ? classify(item.number) : "â€”");
        const idx = Number(modBI(item.issueBI - anchorBI, PLEN));
        const derived = PATTERN[idx];
        const predicted = LOCKS[item.issueStr] ?? derived;
        let resultText = "â€”";
        if (actual==="BIG" || actual==="SMALL"){
          resultText = (predicted===actual) ? "Win" : "Lose";
          rowsForRate.push({ result: resultText });
        }
        cards.push(cardHTML({ issue:item.issueStr, number:item.number, actual, predicted, result: resultText }));
      });
      renderWinrate(rowsForRate);
      cardsEl.innerHTML = cards.join("");
    });
  </script>
</body>
</html>
